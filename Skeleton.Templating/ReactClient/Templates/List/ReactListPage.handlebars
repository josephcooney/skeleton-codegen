// generated by a tool
import React, { FunctionComponent, useRef, useEffect, useState } from 'react';

// material imports
import { TableHead, TableContainer, TableBody, Table, Fab, Grid } from "@mui/material";
import AddIcon from '@mui/icons-material/Add';
import {useTheme} from "@mui/material/styles";

// other libraries
import { useNavigate } from 'react-router-dom';

import { {{cs_name Name}} } from '../{{cs_name Name}}';
import { {{cs_name Name}}Row } from './{{cml_case Name}}Row';
import { {{cs_name Name}}Header } from './{{cml_case Name}}Header';
import { {{UnderlyingType.ClientApiInterfaceName}}, {{UnderlyingType.ClientApiTypeName}} } from '../{{cml_case UnderlyingType.Name}}ApiClient';
import { Loading } from '../../../controls/loading';
import {{cs_name Name}}ListRendering from './{{cml_case Name}}ListRendering';
import Title from "../../../controls/Title";
import {useSnackbar} from "notistack";
import {ResultData} from "../../../http";
import {apiCall} from "../../../api";
import {StyledTable} from "../../../controls/styled-table";
{{#if UnderlyingType.IsReferenceData}}
import { UserConsumer, isAdmin } from '../../../api-authorization/UserContext';
{{/if}}

interface {{cs_name Name}}ListProps {
    data?: {{cs_name Name}}[] | null;
    dataProvided?: boolean | null;
    hideHeading?: boolean | null;
    hideAddButton? : boolean | null;
    linkedType? : string | null;
    linkedId? : number | string | null;
    api? : {{UnderlyingType.ClientApiInterfaceName}} | null;
    onHeaderClick? : (fieldName: string) => void;
}

export const {{cs_name Name}}List : FunctionComponent<{{cs_name Name}}ListProps> = (props: {{cs_name Name}}ListProps) => {

    const api : {{UnderlyingType.ClientApiInterfaceName}} = props.api ?? new {{UnderlyingType.ClientApiTypeName}}();
    const rendering: {{cs_name Name}}ListRendering = new {{cs_name Name}}ListRendering();
    const [state , setState] = useState<{{{ListStateTypeName}}}>({data: props.dataProvided ? props.data ? props.data : [] : [], loading : !props.dataProvided, error: false});
    const mounted = useRef();
    const navigate = useNavigate();
    const { enqueueSnackbar } = useSnackbar();
    const theme = useTheme();

{{#if HasOperations}}
    useEffect(() => {
        if (!mounted.current && state.loading) {
            {{cml_case PrimaryOperation.BareName}}();
        }
    });
{{/if}}

    useEffect(() => {
        if (props.data && (props.data != state.data)) {
            setState({ data: props.data, loading: false, error: false });
        }
    }, [props.data]);

    return render();

    function render{{cs_name Name}}Table(data: {{cs_name Name}}[]) {
		return (
                <TableContainer>
                    <StyledTable>
                        <TableHead>
                            <{{cs_name Name}}Header onClick={props.onHeaderClick} />
                        </TableHead>
                        <TableBody>
                            {data.map(s =>
                                <{{cs_name Name}}Row data={s} key={ s.{{cml_case IdentityField.Name}} } />
                            )}
                        </TableBody>
                    </StyledTable>
                </TableContainer>    
        );
    }

    function onAddClick(){
        navigate('/{{kb_case UnderlyingType.Name}}/add', {replace: false, state:{linkedType: props.linkedType, linkedId: props.linkedId}});
    }

	function render() {

		var contents = null;
        if (state.error) {
            contents = renderError();
        } else {
            if (state.loading) {
                contents = <Loading />;
            } else {
				contents = state.data && state.data.length > 0 ? renderData() : null;
			}
        }

        const buttonRowStyle = {paddingTop: theme.spacing(1), paddingBottom: theme.spacing(1)};

        return (
            <React.Fragment>
                { renderHeading() }                
                { renderDescription() }
                {contents}
                {{has UnderlyingType.AddOperations}}
                {props.hideAddButton ? null :
                    (
                    {{#if UnderlyingType.IsReferenceData}}
                        <UserConsumer>
                            {userProps => {
                            return isAdmin(userProps) ? (<Grid container direction="column" alignItems="flex-end" style={buttonRowStyle}>
                            <Fab onClick={onAddClick} size="medium" color="primary" aria-label="add {{UnderlyingType.HumanizedName}}">
                                <AddIcon />
                            </Fab>
                        </Grid>) : null;} }
                        </UserConsumer>
                    {{else}}
                        <Grid container direction="column" alignItems="flex-end" style={buttonRowStyle}>
                            <Fab onClick={onAddClick} size="medium" color="primary" aria-label="add {{UnderlyingType.HumanizedName}}">
                                <AddIcon />
                            </Fab>
                        </Grid>
                    {{/if}}
                    )
                }
                {{/has}}
            </React.Fragment>
        );
    }

	function renderHeading() {
        if (props.hideHeading) {
            return null;
        }
        var customHeading = rendering.renderCustomHeading(state);
        return customHeading ? customHeading : (<Title>{{UnderlyingType.HumanizedNamePlural}}</Title>);
    }

    function renderError() {
        var customError = rendering.renderCustomError(state);
        return customError ? customError : <p><em>Error</em> : {state.message}</p>;
    }

    function renderData() {
        var customData = rendering.renderCustomData(state);
        return customData ? customData : render{{cs_name Name}}Table(state.data ?? []);
    }

    function renderDescription() {
        var customDescription = rendering.renderCustomDescription(state);
        return customDescription
            ? customDescription
            : ((state.data && state.data.length > 0) || state.loading ? null : <Grid container><Grid item xs={12}>There are no {{UnderlyingType.HumanizedNamePlural}}</Grid></Grid>);
    }

	{{#each Operations}}
    function {{cml_case BareName}}() {
        apiCall(api.{{cml_case BareName}}(), setState, {errorText: 'Error fetching {{../UnderlyingType.HumanizedNamePlural}}.'}, enqueueSnackbar);
    }
	
	{{/each}}
}
