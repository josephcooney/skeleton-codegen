// generated by a tool
using Npgsql;
using System;
using System.Collections.Generic;
using System.Data;
using System.Data.Common;
using System.Threading;
using System.Threading.Tasks;
using Microsoft.Extensions.Configuration;
using NpgsqlTypes;
using {{cs_name Namespace}}.Data.Domain; 
{{#if HasCustomResultType}}
using {{cs_name Namespace}}.Data.Model; 
{{/if}}

namespace {{cs_name Namespace}}.Data.Repository 
{
    public partial interface I{{cs_name Type.Name}}Repository 
    {
    {{#each Operations}}
    
        {{{ReturnsWithNullability}}} {{cs_name BareName}}({{#each Parameters}}{{{ResolvedClrType}}} {{cml_case Name}}{{#unless @last}}, {{/unless}}{{/each}});
        
        {{#if NoResult}}Task{{else}}Task<{{{ReturnsWithNullability}}}>{{/if}} {{cs_name BareName}}Async({{#each Parameters}}{{{ResolvedClrType}}} {{cml_case Name}}, {{/each}} CancellationToken token);

    {{/each}}        
    }

    public partial class {{cs_name Type.Name}}Repository : RepositoryBase, I{{cs_name Type.Name}}Repository
    {
        private string _connectionString;

        public {{cs_name Type.Name}}Repository(IConfiguration configuration)
        {
            _connectionString = BuildConnectionString(configuration);
        }

        {{#each Operations}}

        public {{{ReturnsWithNullability}}} {{cs_name BareName}}({{#each Parameters}}{{{ResolvedClrType}}} {{cml_case Name}}{{#unless @last}}, {{/unless}}{{/each}})
        {
            try 
            {
                using (var cn = CreateConnection(_connectionString))
                using (var cmd = new NpgsqlCommand("{{SqlName}}", cn))
                {
                    cmd.CommandType = CommandType.StoredProcedure;
    
                    {{#if HasParameters}}
                    Set{{cs_name BareName}}Parameters(cmd, {{#each Parameters}}{{cml_case Name}}{{#unless @last}}, {{/unless}}{{/each}});
                    {{/if}}
    
                    cn.Open();
    
                    {{#if NoResult}}
                    cmd.ExecuteNonQuery();
                    {{else}}
                    {{#if IsSingular}}
                    return ({{{ReturnTypeName}}})cmd.ExecuteScalar();
                    {{else}}
                    using (var reader = cmd.ExecuteReader())
                    {
                        {{#if SingleResult}}
                        return reader.Read() ? Read{{cs_name BareName}}Result(reader) : null;
                        {{else}}
                        var readResults = false;
                        var result = new {{{Returns}}}();
                        while (reader.Read())
                        {
                            var item = Read{{cs_name BareName}}Result(reader);
                            result.Add(item);    
                            readResults = true;
                        }

                        return readResults ? result : null;
                        {{/if}}
                    }	
                    {{/if}}
                    {{/if}}
                }
            }
            catch (NpgsqlException ex)
            {
                var generalException = TranslateException(ex);
                throw generalException;
            }
        }

		public async {{#if NoResult}}Task{{else}}Task<{{{ReturnsWithNullability}}}>{{/if}} {{cs_name BareName}}Async({{#each Parameters}}{{{ResolvedClrType}}} {{cml_case Name}}, {{/each}} CancellationToken token)
        {
            try 
            {
                using (var cn = CreateConnection(_connectionString))
                using (var cmd = new NpgsqlCommand("{{SqlName}}", cn))
                {
                    cmd.CommandType = CommandType.StoredProcedure;
    
                    {{#if HasParameters}}
                    Set{{cs_name BareName}}Parameters(cmd, {{#each Parameters}}{{cml_case Name}}{{#unless @last}}, {{/unless}}{{/each}});
                    {{/if}}
                    await cn.OpenAsync(token);
    
                    {{#if NoResult}}
                    await cmd.ExecuteNonQueryAsync(token);
                    {{else}}
                    {{#if IsSingular}}
                    var result = await cmd.ExecuteScalarAsync(token);
                    return ({{{ReturnTypeName}}})result;
                    {{else}}
                    using (var reader = await cmd.ExecuteReaderAsync(token))
                    {
                    {{#if SingleResult}}
                        return await reader.ReadAsync(token) ? Read{{cs_name BareName}}Result(reader) : null;
                    {{else}}
                        var readResults = false;
                        var result = new {{{Returns}}}();
                        while (await reader.ReadAsync(token))
                        {
                            var item = Read{{cs_name BareName}}Result(reader);
                            result.Add(item);
                            readResults = true;
                        }

                        return readResults ? result : null;
                    {{/if}}
                    }	
                    {{/if}}
                    {{/if}}
                }
            }
            catch (NpgsqlException ex)
            {
                var generalException = TranslateException(ex);
                throw generalException;
            }
        }

        {{#if HasParameters}}
        private void Set{{cs_name BareName}}Parameters(NpgsqlCommand cmd, {{#each Parameters}}{{{ResolvedClrType}}} {{cml_case Name}}{{#unless @last}}, {{/unless}}{{/each}})
        {    
			{{#if IsSearch}}
			{{#each Parameters}}
			{{#if IsSecurityUser}}
			cmd.Parameters.AddWithValue("{{Name}}", NpgsqlDbType.{{db_type_to_cs ProviderTypeName}}, {{cml_case Name}});
			{{else}}
			SetSearchParameterValue({{cml_case Name}}, cmd, "{{Name}}");
			{{/if}}
			{{/each}}
			{{else}}
			{{#each Parameters}}
			{{#if IsJson}}
			cmd.Parameters.AddWithValue("{{Name}}", NpgsqlDbType.{{db_type_to_cs ProviderTypeName}}, (object){{cml_case Name}} ?? DBNull.Value);
			{{else}}
                {{#if IsCustomTypeOrCustomArray}}
            cmd.Parameters.Add(new NpgsqlParameter{ParameterName = "{{Name}}", Value = {{cml_case Name}} });
                {{else}}
                    {{#if IsNullable}}
            SetParameterValue({{cml_case Name}}, cmd, "{{Name}}", NpgsqlDbType.{{db_type_to_cs ProviderTypeName}});
                    {{else}}
            cmd.Parameters.AddWithValue("{{Name}}", NpgsqlDbType.{{db_type_to_cs ProviderTypeName}}, {{cml_case Name}});
                    {{/if}}
                {{/if}}
			{{/if}}
			{{/each}}
			{{/if}}
        }
        {{/if}}

        {{#unless NoResult}}
        {{#unless IsSingular}}
        private {{{ReturnTypeName}}} Read{{cs_name BareName}}Result(DbDataReader reader)
        {
			{{#each SimpleReturnType.Fields}}
			{{#unless IsExcludedFromResults}}
			var {{cml_case Name}} = GetField<{{format_clr_type ClrType}}>(reader, "{{Name}}");
			{{/unless}}
			{{/each}}
            var item = new {{{ReturnTypeName}}}({{#each SimpleReturnType.Fields}}{{#unless IsExcludedFromResults}}{{cml_case Name}}{{#unless @last}}, {{/unless}}{{/unless}}{{/each}});
            return item;
        }
        {{/unless}}
        {{/unless}}
        {{/each}}
    }

}