-- generated by a tool
SET search_path TO {{{escape_sql Namespace}}};

CREATE OR REPLACE FUNCTION {{{escape_sql FunctionName}}} (
{{#each UpdateInputFields}}
{{{escape_sql Name}}} {{{escape_sql_name ProviderTypeName}}}{{#if HasSize}}({{Size}}){{/if}}{{#unless @last}},{{/unless}}
{{/each}}
) RETURNS int AS
$$
    declare update_count int;
    BEGIN

        {{#if Domain.HasUserType}}
        IF (security_user_id_param is not null) THEN
            perform set_config('app.user_id', security_user_id_param::text, true);
        END IF;
        {{/if}}

        UPDATE {{{escape_sql Name}}}
        SET 
            {{#each UpdateFields}}
            {{{escape_sql Name}}} = {{{Value}}}{{#unless @last}},{{/unless}}
            {{/each}}
        WHERE
        {{#each PrimaryKeyFields}}
            {{{escape_sql Parent.Name}}}.{{{escape_sql Name}}} = {{{escape_sql Parent.FunctionName}}}.{{{escape_sql Name}}}{{#unless @last}} AND{{/unless}}{{/each}}{{#if SoftDelete}} AND deleted_date is NULL{{/if}};

        get diagnostics update_count = row_count;
        
        return update_count;
        
    END
$$
  LANGUAGE plpgsql VOLATILE SECURITY INVOKER
  COST 100;

REVOKE ALL ON FUNCTION {{{escape_sql FunctionName}}} ({{#each UpdateInputFields}} {{{escape_sql_name ProviderTypeName}}}{{#if HasSize}}({{Size}}){{/if}}{{#unless @last}},{{/unless}} {{/each}}) FROM public;

GRANT EXECUTE ON FUNCTION {{{escape_sql FunctionName}}} ({{#each UpdateInputFields}} {{{escape_sql_name ProviderTypeName}}}{{#if HasSize}}({{Size}}){{/if}}{{#unless @last}},{{/unless}} {{/each}}) TO web_app_role;

COMMENT ON FUNCTION {{{escape_sql FunctionName}}} ({{#each UpdateInputFields}} {{{escape_sql_name ProviderTypeName}}}{{#if HasSize}}({{Size}}){{/if}}{{#unless @last}},{{/unless}} {{/each}})
    IS '{"applicationtype":"{{Name}}", "generated":true, "changesData":true, "friendlyName":"Edit", "fullName":"{{FunctionName}}" {{#if NoEditUI}},"ui":false, "api":false {{/if}} }';