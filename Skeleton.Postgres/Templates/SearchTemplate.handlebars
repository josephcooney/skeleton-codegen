-- generated by a tool
SET search_path TO {{{escape_sql Namespace}}};

CREATE OR REPLACE FUNCTION {{FunctionName}} (
	security_user_id_param integer,
	search_text character varying -- search text needs to be 'formatted' for full text search before calling e.g. 'Foo Bar' needs to be transformed to 'foo:* & bar:*'. c# Repository SetSearchParameterValue does this.
) 
RETURNS TABLE({{#each DisplayAllFields}} {{#if HasDisplayName}}{{{escape_sql DisplayName}}}{{else}}{{{escape_sql Name}}}{{/if}}  {{{escape_sql_name ProviderTypeName}}}{{#if HasSize}}({{Size}}){{/if}}{{#unless @last}},{{/unless}}{{/each}}) AS
$$
    DECLARE
	ts_search_text tsquery;
    BEGIN

        {{#if Domain.HasUserType}}
        IF (security_user_id_param is not null) THEN
            perform set_config('app.user_id', security_user_id_param::text, true);
        END IF;
        {{/if}}

		ts_search_text = to_tsquery({{FunctionName}}.search_text);

        RETURN QUERY
        SELECT
            {{#each DisplayAllFields}}
            {{ParentAlias}}.{{{escape_sql Name}}}{{#if HasDisplayName}} AS {{{escape_sql DisplayName}}}{{/if}}{{#unless @last}},{{/unless}}
            {{/each}}
        FROM {{{escape_sql Name}}} {{ShortName}}
        {{#each RelatedFields}}
        LEFT JOIN {{{escape_sql Field.ReferencesType.Name}}} AS {{ParentAlias}} ON {{PrimaryAlias}}.{{{escape_sql Field.Name}}} = {{ParentAlias}}.{{{escape_sql Field.ReferencesTypeField.Name}}} 
        {{/each}}
		WHERE {{ShortName}}.search_content @@ ts_search_text
        {{#if SoftDelete}}
        AND {{ShortName}}.deleted_date is NULL
        {{/if}}
		ORDER BY ts_rank({{ShortName}}.search_content, ts_search_text) DESC 
		LIMIT 20;
        
    END
$$
  LANGUAGE plpgsql STABLE SECURITY INVOKER
  COST 100;

REVOKE ALL ON FUNCTION {{FunctionName}} (integer, character varying) FROM public;

GRANT EXECUTE ON FUNCTION {{FunctionName}} (integer, character varying) TO web_app_role;

COMMENT ON FUNCTION {{FunctionName}} (integer, character varying)
    IS '{"applicationtype":"{{Name}}", "generated":true, "fullName":"{{FunctionName}}", "returnTypeName":"{{Name}}_select_for_display_result" }';
