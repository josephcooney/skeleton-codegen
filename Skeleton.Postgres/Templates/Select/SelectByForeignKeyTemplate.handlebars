-- generated by a tool
SET search_path TO {{{escape_sql Namespace}}};

drop function if exists {{{escape_sql FunctionName}}};

CREATE OR REPLACE FUNCTION {{{escape_sql FunctionName}}} (
{{#each SelectInputFields}}
{{{escape_sql Name}}} {{{escape_sql_name ProviderTypeName}}}{{#if HasSize}}({{Size}}){{/if}}{{#unless @last}},{{/unless}}
{{/each}}
)
RETURNS {{#unless ReturnsSingle}}SETOF {{/unless}}{{{ResultTypeName}}} AS
$$
{{#if ReturnsSingle}}DECLARE result {{{ResultTypeName}}};{{/if}}
    BEGIN

    {{#if Domain.HasUserType}}
        IF (security_user_id_param is not null) THEN
            perform set_config('app.user_id', security_user_id_param::text, true);
        END IF;
    {{/if}}

        {{#unless ReturnsSingle}}RETURN QUERY{{/unless}}
        SELECT
            {{#each Fields}}
            {{{escape_sql Parent.Name}}}.{{{escape_sql Name}}}{{#unless @last}},{{/unless}}
            {{/each}}
        FROM {{{escape_sql Name}}}
        WHERE 
        {{#each SelectFields}}
        {{{escape_sql Parent.Name}}}.{{{escape_sql Name}}} = {{{escape_sql Parent.FunctionName}}}.{{{escape_sql Name}}} {{#unless @last}}AND{{/unless}}{{#unless ../SoftDelete}}{{#if ../ReturnsSingle}} into result{{/if}};{{/unless}}
        {{/each}}
		{{#if SoftDelete}}
        AND deleted_date is NULL {{#if ReturnsSingle}} into result{{/if}};
        {{/if}}
        {{#if ReturnsSingle}}RETURN result;{{/if}}
    END
$$
  LANGUAGE plpgsql STABLE SECURITY INVOKER
  COST 100;

{{#if UseDbRoleForSecurity}}
REVOKE ALL ON FUNCTION {{{escape_sql FunctionName}}} ({{#each SelectInputFields}}{{{escape_sql_name ProviderTypeName}}}{{#if HasSize}}({{Size}}){{/if}}{{#unless @last}},{{/unless}}{{/each}}) FROM public;

GRANT EXECUTE ON FUNCTION {{{escape_sql FunctionName}}} ({{#each SelectInputFields}} {{{escape_sql_name ProviderTypeName}}}{{#if HasSize}}({{Size}}){{/if}}{{#unless @last}},{{/unless}} {{/each}}) TO web_app_role;
{{/if}}

COMMENT ON FUNCTION {{{escape_sql FunctionName}}} ({{#each SelectInputFields}} {{{escape_sql_name ProviderTypeName}}}{{#if HasSize}}({{Size}}){{/if}}{{#unless @last}},{{/unless}} {{/each}})
    IS '{"applicationtype":"{{Name}}", "generated":true, "fullName":"{{FunctionName}}" {{#if ReturnsSingle}}, "single_result":true{{/if}} }';