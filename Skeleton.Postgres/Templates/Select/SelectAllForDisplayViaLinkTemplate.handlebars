-- generated by a tool
SET search_path TO {{{escape_sql_keyword Namespace}}};

drop function if exists {{{escape_sql_keyword FunctionName}}};

CREATE OR REPLACE FUNCTION {{{escape_sql_keyword FunctionName}}} (
{{#each SelectInputFields}}
{{{escape_sql_keyword Name}}} {{ProviderTypeName}}{{#if HasSize}}({{Size}}){{/if}}{{#unless @last}},{{/unless}}
{{/each}}
) 
RETURNS SETOF {{Name}}_display AS
$$
    
    BEGIN

        IF (security_user_id_param is not null) THEN
		    perform set_config('app.user_id', security_user_id_param::text, true);
        END IF;

        RETURN QUERY
        SELECT
            {{#each DisplayAllFields}}
            {{ParentAlias}}.{{{escape_sql_keyword Name}}}{{#if HasDisplayName}} AS {{{escape_sql_keyword DisplayName}}}{{/if}}{{#unless @last}},{{/unless}}
            {{/each}}
        FROM {{{escape_sql_keyword Name}}} {{ShortName}}
        {{#each RelatedFields}}
        LEFT JOIN {{{escape_sql_keyword Field.ReferencesType.Name}}} AS {{ParentAlias}} ON {{PrimaryAlias}}.{{escape_sql_keyword Field.Name}} = {{ParentAlias}}.{{escape_sql_keyword Field.ReferencesTypeField.Name}} 
        {{/each}}
		LEFT JOIN {{{escape_sql_keyword LinkingType.Name}}} AS {{LinkTypeAlias}} ON {{LinkTypeAlias}}.{{escape_sql_keyword LinkingTypeField.Name}} = {{ShortName}}.{{{escape_sql_keyword LinkingTypeField.ReferencesTypeField.Name}}}
        WHERE {{LinkTypeAlias}}.{{{escape_sql_keyword LinkTypeOtherField.Name}}} = {{{escape_sql_keyword FunctionName}}}.{{{escape_sql_keyword LinkTypeOtherField.Name}}}
        {{#if FilterListOperation}}
        AND {{OwnershipExpression}}
            {{#if SoftDelete}}
        AND {{ShortName}}.deleted_date is NULL
            {{/if}}        
        {{else}}
            {{#if SoftDelete}}
        AND {{ShortName}}.deleted_date is NULL
            {{/if}}
        {{/if}}        
        /* */ ;
        
    END
$$
  LANGUAGE plpgsql STABLE SECURITY INVOKER
  COST 100;

REVOKE ALL ON FUNCTION {{{escape_sql_keyword FunctionName}}} ({{#each SelectInputFields}} {{ProviderTypeName}}{{#if HasSize}}({{Size}}){{/if}}{{#unless @last}},{{/unless}} {{/each}}) FROM public;

GRANT EXECUTE ON FUNCTION {{{escape_sql_keyword FunctionName}}} ({{#each SelectInputFields}} {{ProviderTypeName}}{{#if HasSize}}({{Size}}){{/if}}{{#unless @last}},{{/unless}} {{/each}}) TO web_app_role;

COMMENT ON FUNCTION {{{escape_sql_keyword FunctionName}}} ({{#each SelectInputFields}} {{ProviderTypeName}}{{#if HasSize}}({{Size}}){{/if}}{{#unless @last}},{{/unless}} {{/each}})
    IS '{"applicationtype":"{{Name}}", "generated":true, "fullName":"{{FunctionName}}"}';
