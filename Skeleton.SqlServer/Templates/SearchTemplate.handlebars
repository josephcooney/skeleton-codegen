-- generated by a tool
CREATE OR ALTER FUNCTION {{{escape_sql_keyword Namespace}}}.{{FunctionName}} (
	security_user_id_param integer,
	search_text character varying -- search text needs to be 'formatted' for full text search before calling e.g. 'Foo Bar' needs to be transformed to 'foo:* & bar:*'. c# Repository SetSearchParameterValue does this.
) 
RETURNS TABLE({{#each DisplayAllFields}} {{#if HasDisplayName}}{{{escape_sql_keyword DisplayName}}}{{else}}{{{escape_sql_keyword Name}}}{{/if}}  {{ProviderTypeName}}{{#if HasSize}}({{Size}}){{/if}}{{#unless @last}},{{/unless}}{{/each}}) AS
$$
    DECLARE
	ts_search_text tsquery;
    BEGIN
		
        IF (security_user_id_param is not null) THEN
		    perform set_config('app.user_id', security_user_id_param::text, true);
        END IF;

		ts_search_text = to_tsquery({{FunctionName}}.search_text);

        RETURN QUERY
        SELECT
            {{#each DisplayAllFields}}
            {{ParentAlias}}.{{{escape_sql_keyword Name}}}{{#if HasDisplayName}} AS {{{escape_sql_keyword DisplayName}}}{{/if}}{{#unless @last}},{{/unless}}
            {{/each}}
        FROM {{{escape_sql_keyword Name}}} {{ShortName}}
        {{#each RelatedFields}}
        LEFT JOIN {{{escape_sql_keyword Field.ReferencesType.Name}}} AS {{ParentAlias}} ON {{PrimaryAlias}}.{{escape_sql_keyword Field.Name}} = {{ParentAlias}}.{{escape_sql_keyword Field.ReferencesTypeField.Name}} 
        {{/each}}
		WHERE {{ShortName}}.search_content @@ ts_search_text
        {{#if SoftDelete}}
        AND {{ShortName}}.deleted_date is NULL
        {{/if}}
		ORDER BY ts_rank({{ShortName}}.search_content, ts_search_text) DESC 
		LIMIT 20;
        
    END
$$
  LANGUAGE plpgsql STABLE SECURITY INVOKER
  COST 100;

REVOKE ALL ON FUNCTION {{FunctionName}} (integer, character varying) FROM public;

GRANT EXECUTE ON FUNCTION {{FunctionName}} (integer, character varying) TO web_app_role;

COMMENT ON FUNCTION {{FunctionName}} (integer, character varying)
    IS '{"applicationtype":"{{Name}}", "generated":true, "fullName":"{{FunctionName}}", "returnTypeName":"{{Name}}_select_for_display_result" }';
